<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Document Analyzer</title>
    <link rel="stylesheet" href="/static/styles.css">
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <h1>Financial Document Analyzer</h1>
        
        <div class="upload-section" id="uploadSection">
            <input type="file" id="fileInput" accept=".pdf" />
            <button onclick="document.getElementById('fileInput').click()">Select PDF Document</button>
            <p>Drop PDF file here or click to select</p>
        </div>

        <div class="loading" id="loadingIndicator">
            <div class="spinner"></div>
            <p>Analyzing document... Please wait...</p>
        </div>

        <div class="error-message"></div>

        <div class="results-section">
            <!-- Previous content remains the same -->
        </div>
    </div>

    <script>
        // Get the current URL for API calls
        const BASE_URL = window.location.origin;
        console.log('Base URL:', BASE_URL);

        let metricsChart = null;
        let ratiosChart = null;
        let documentAnalyzed = false;
        let currentDocumentId = null;

        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('fileInput');
            const loadingDiv = document.getElementById('loadingIndicator');
            const resultsSection = document.querySelector('.results-section');
            const errorMessage = document.querySelector('.error-message');
            const uploadSection = document.getElementById('uploadSection');
            const questionInput = document.getElementById('questionInput');
            const sendButton = document.getElementById('sendButton');
            const chatMessages = document.getElementById('chatMessages');
            const typingIndicator = document.getElementById('typingIndicator');

            console.log('DOM loaded, setting up event listeners');

            // File input change handler
            fileInput.addEventListener('change', (e) => {
                console.log('File input changed');
                const files = e.target.files;
                console.log('Files:', files);
                if (files && files.length > 0) {
                    const file = files[0];
                    console.log('Selected file:', file.name, file.type, file.size);
                    handleFileUpload(file);
                }
            });

            // Drag and drop handlers
            uploadSection.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                console.log('File dragged over upload section');
                uploadSection.style.borderColor = '#007bff';
            });

            uploadSection.addEventListener('dragleave', (e) => {
                e.preventDefault();
                e.stopPropagation();
                console.log('File dragged out of upload section');
                uploadSection.style.borderColor = '#ccc';
            });

            uploadSection.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                console.log('File dropped');
                uploadSection.style.borderColor = '#ccc';
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    console.log('Dropped file:', files[0].name);
                    handleFileUpload(files[0]);
                }
            });

            async function handleFileUpload(file) {
                console.log('Handling file upload:', file.name);
                
                if (!file.name.endsWith('.pdf')) {
                    showError('Please select a PDF file');
                    return;
                }

                const formData = new FormData();
                formData.append('file', file);

                showLoading(file);

                try {
                    const url = `${BASE_URL}/analyze`;
                    console.log('Sending file to server:', url);
                    const response = await fetch(url, {
                        method: 'POST',
                        body: formData
                    });

                    console.log('Response received:', response);
                    console.log('Response status:', response.status);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log('Response data:', data);

                    hideLoading();
                    
                    if (data.error) {
                        showError(data.error);
                    } else {
                        try {
                            console.log('Parsing analysis:', data.analysis);
                            const analysis = JSON.parse(data.analysis);
                            console.log('Parsed analysis:', analysis);
                            
                            displayResults(analysis);
                            documentAnalyzed = true;
                            currentDocumentId = data.documentId;
                            sendButton.disabled = !questionInput.value.trim();
                            addMessage("I've analyzed the document. Feel free to ask any specific questions about the financial data!", false);
                        } catch (e) {
                            console.error('Error parsing analysis:', e);
                            showError('Error parsing analysis results: ' + e.message);
                        }
                    }
                } catch (error) {
                    console.error('Network or processing error:', error);
                    hideLoading();
                    showError('Error analyzing document: ' + error.message);
                }
            }

            function showLoading(file) {
                console.log('Showing loading state for:', file.name);
                loadingDiv.style.display = 'block';
                loadingDiv.querySelector('p').textContent = `Analyzing ${file.name}... Please wait...`;
                uploadSection.style.display = 'none';
                resultsSection.style.display = 'none';
                errorMessage.style.display = 'none';
            }

            function hideLoading() {
                console.log('Hiding loading state');
                loadingDiv.style.display = 'none';
                uploadSection.style.display = 'block';
            }

            function showError(message) {
                console.error('Showing error:', message);
                errorMessage.textContent = message;
                errorMessage.style.display = 'block';
                resultsSection.style.display = 'none';
                documentAnalyzed = false;
                sendButton.disabled = true;
                currentDocumentId = null;
            }

            // Rest of your JavaScript code...
        });
    </script>
</body>
</html>
