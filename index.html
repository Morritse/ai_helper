<!DOCTYPE html>
<html lang="en">
<!-- Previous head and body content remains the same until the script section -->

<script>
    let templates = {};
    let currentTemplate = null;
    let documentAnalyzed = false;
    let currentDocumentId = null;

    // Load templates when page loads
    window.addEventListener('DOMContentLoaded', loadTemplates);

    async function loadTemplates() {
        try {
            const response = await fetch('/templates');
            const data = await response.json();
            
            // Store templates
            templates = data.templates.reduce((acc, template) => {
                acc[template.id] = template;
                return acc;
            }, {});
            
            // Update dropdown
            updateTemplateSelect();
            
        } catch (error) {
            console.error('Error loading templates:', error);
            document.getElementById('templateSelect').innerHTML = 
                '<option value="">Error loading templates</option>';
        }
    }

    function updateTemplateSelect() {
        const select = document.getElementById('templateSelect');
        select.innerHTML = `
            <option value="">Select a template...</option>
            ${Object.values(templates).map(template => 
                `<option value="${template.id}">${template.name}</option>`
            ).join('')}
        `;
        updateTemplateDescription();
    }

    function updateTemplateDescription() {
        const select = document.getElementById('templateSelect');
        const description = document.getElementById('templateDescription');
        const selectedTemplate = templates[select.value];
        
        if (selectedTemplate) {
            description.textContent = selectedTemplate.description;
            description.style.display = 'block';
        } else {
            description.textContent = 'Please select a template';
            description.style.display = 'block';
        }
    }

    function showTemplateBuilder() {
        document.getElementById('templateBuilderModal').style.display = 'block';
    }

    function hideTemplateBuilder() {
        document.getElementById('templateBuilderModal').style.display = 'none';
        document.getElementById('templateForm').reset();
    }

    async function createTemplate(event) {
        event.preventDefault();
        
        showLoading('Creating template...');
        
        try {
            const response = await fetch('/create_template', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: document.getElementById('templateName').value,
                    description: document.getElementById('description').value,
                    metrics: document.getElementById('metrics').value,
                    visualizations: document.getElementById('visualizations').value
                })
            });
            
            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            // Add new template to list
            templates[data.template_id] = data.template;
            updateTemplateSelect();
            
            // Select the new template
            document.getElementById('templateSelect').value = data.template_id;
            updateTemplateDescription();
            
            // Hide modal and show success message
            hideTemplateBuilder();
            showSuccess('Template created successfully! You can now upload a document.');
            
        } catch (error) {
            showError('Error creating template: ' + error.message);
        } finally {
            hideLoading();
        }
    }

    // File Upload Handling
    const fileInput = document.getElementById('fileInput');
    const uploadSection = document.getElementById('uploadSection');

    uploadSection.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.stopPropagation();
        uploadSection.style.borderColor = '#007bff';
    });

    uploadSection.addEventListener('dragleave', (e) => {
        e.preventDefault();
        e.stopPropagation();
        uploadSection.style.borderColor = '#ccc';
    });

    uploadSection.addEventListener('drop', (e) => {
        e.preventDefault();
        e.stopPropagation();
        uploadSection.style.borderColor = '#ccc';
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFileUpload(files[0]);
        }
    });

    fileInput.addEventListener('change', (e) => {
        if (e.target.files && e.target.files[0]) {
            handleFileUpload(e.target.files[0]);
        }
    });

    async function handleFileUpload(file) {
        const templateId = document.getElementById('templateSelect').value;
        if (!templateId) {
            showError('Please select a template first');
            return;
        }
        
        if (!file.name.endsWith('.pdf')) {
            showError('Please select a PDF file');
            return;
        }

        const formData = new FormData();
        formData.append('file', file);
        formData.append('template', templateId);

        showLoading('Analyzing document... Please wait...');

        try {
            const response = await fetch('/analyze', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();

            if (data.error) {
                throw new Error(data.error);
            }

            // Parse and display results
            const analysis = JSON.parse(data.analysis);
            displayResults(analysis, data.template);
            
            // Update state
            documentAnalyzed = true;
            currentDocumentId = data.documentId;
            currentTemplate = data.template;
            
            // Enable chat
            document.getElementById('sendButton').disabled = !document.getElementById('questionInput').value.trim();
            addMessage("I've analyzed the document. Feel free to ask any specific questions!", false);
            
            // Show success message
            showSuccess('Document analyzed successfully!');
            
        } catch (error) {
            showError('Error analyzing document: ' + error.message);
        } finally {
            hideLoading();
        }
    }

    function showSuccess(message) {
        const successDiv = document.createElement('div');
        successDiv.className = 'success-message';
        successDiv.textContent = message;
        document.querySelector('.template-section').appendChild(successDiv);
        setTimeout(() => successDiv.remove(), 5000);
    }

    function showError(message) {
        const errorDiv = document.querySelector('.error-message');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        setTimeout(() => {
            errorDiv.style.display = 'none';
        }, 5000);
    }

    function showLoading(message = 'Processing...') {
        const loadingIndicator = document.getElementById('loadingIndicator');
        loadingIndicator.querySelector('p').textContent = message;
        loadingIndicator.style.display = 'block';
        uploadSection.style.display = 'none';
    }

    function hideLoading() {
        const loadingIndicator = document.getElementById('loadingIndicator');
        loadingIndicator.style.display = 'none';
        uploadSection.style.display = 'block';
    }

    // Rest of the JavaScript code (displayResults, createVisualization, chat functionality) remains the same...
</script>

<!-- Previous styles remain the same -->
